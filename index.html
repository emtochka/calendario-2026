<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Disponibilidad 2026</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ¬°¬°¬°ATENCI√ìN!!! - REEMPLAZA CON TU URL DE GOOGLE APPS SCRIPT
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyU7xaflsNd5yuCU5y4_h1B4Y9vmGKLOrbo83gPIduQ1nkwKeL6pNbJT1p1Ex_KhY4qtw/exec';
        
        const PASSWORD = 'huvh';

        const CalendarioDisponibilidad = () => {
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [passwordInput, setPasswordInput] = useState('');
            const [passwordError, setPasswordError] = useState('');
            const [currentMonth, setCurrentMonth] = useState(0);
            const [personName, setPersonName] = useState('');
            const [personList, setPersonList] = useState([]);
            const [availability, setAvailability] = useState({});
            const [loading, setLoading] = useState(false);
            const [sheetConfigured, setSheetConfigured] = useState(false);

            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            // Verificar autenticaci√≥n al cargar
            useEffect(() => {
                const savedAuth = localStorage.getItem('calendarAuth');
                if (savedAuth === PASSWORD) {
                    setIsAuthenticated(true);
                }
            }, []);

            // Carga inicial de datos
            useEffect(() => {
                const loadInitialData = async () => {
                    if (SCRIPT_URL.includes('TU_SCRIPT_ID')) {
                        setSheetConfigured(false);
                        return;
                    }
                    
                    setLoading(true);
                    try {
                        console.log('üîç Probando conexi√≥n con:', SCRIPT_URL);
                        
                        // 1. Verificar conexi√≥n
                        const testResponse = await fetch(`${SCRIPT_URL}?action=test`);
                        console.log('üì° Respuesta test:', testResponse.status, testResponse.statusText);
                        
                        if (!testResponse.ok) {
                            throw new Error(`Error de conexi√≥n: ${testResponse.status}`);
                        }
                        
                        const testData = await testResponse.json();
                        console.log('‚úÖ Test exitoso:', testData);
                        setSheetConfigured(true);
                        
                        // 2. Obtener lista de nombres
                        console.log('üìã Obteniendo nombres...');
                        const namesResponse = await fetch(`${SCRIPT_URL}?action=getNames`);
                        const namesResult = await namesResponse.json();
                        
                        console.log('üìã Nombres recibidos:', namesResult);
                        
                        if (namesResult.success && namesResult.data) {
                            setPersonList(namesResult.data);
                        } else {
                            throw new Error(namesResult.message || 'No se pudieron cargar los nombres.');
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Error al inicializar:', error);
                        console.error('‚ùå Detalles:', error.message, error.stack);
                        setSheetConfigured(false);
                        alert(`Error al conectar con Google Sheets: ${error.message}\n\nPosibles causas:\n1. El script no est√° desplegado correctamente\n2. Los permisos no son "Cualquier persona"\n3. Problema de CORS (si est√°s en GitHub Pages)\n\nAbre la consola del navegador (F12) para m√°s detalles.`);
                    } finally {
                        setLoading(false);
                    }
                };
                
                loadInitialData();
            }, []);

            const getDaysInMonth = (month) => {
                return new Date(2026, month + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (month) => {
                const firstDay = new Date(2026, month, 1).getDay();
                return firstDay === 0 ? 6 : firstDay - 1;
            };

            const getDateString = (month, day) => {
                return `2026-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            };

            const handleDayClick = (dateString) => {
                setAvailability(prev => {
                    const current = prev[dateString] || 'neutral';
                    // ORDEN: Neutral ‚Üí Rojo (1 clic) ‚Üí Verde (2 clics) ‚Üí Neutral (3 clics)
                    const next = current === 'neutral' ? 'unavailable' : 
                                 current === 'unavailable' ? 'available' : 'neutral';
                    
                    if (next === 'neutral') {
                        const newAvail = { ...prev };
                        delete newAvail[dateString];
                        return newAvail;
                    }
                    
                    return { ...prev, [dateString]: next };
                });
            };

            const getDayColor = (dateString) => {
                const status = availability[dateString] || 'neutral';
                if (status === 'available') return 'bg-green-500 text-white';
                if (status === 'unavailable') return 'bg-red-500 text-white';
                return 'bg-gray-100 hover:bg-gray-200';
            };

            const handleLogin = (e) => {
                e.preventDefault();
                if (passwordInput === PASSWORD) {
                    localStorage.setItem('calendarAuth', PASSWORD);
                    setIsAuthenticated(true);
                    setPasswordError('');
                } else {
                    setPasswordError('Contrase√±a incorrecta');
                    setPasswordInput('');
                }
            };

            const handleLogout = () => {
                localStorage.removeItem('calendarAuth');
                setIsAuthenticated(false);
                setPasswordInput('');
            };

            const handleNameChange = (e) => {
                const newName = e.target.value;
                setPersonName(newName);
                if (newName) {
                    loadPersonData(newName);
                } else {
                    setAvailability({});
                }
            };
            
            const savePersonData = async () => {
                if (!personName) {
                    alert('Por favor selecciona tu nombre del desplegable');
                    return;
                }
                if (!sheetConfigured) {
                    alert('Error: El script de Google Sheets no est√° configurado.');
                    return;
                }

                setLoading(true);
                
                const formData = new FormData();
                formData.append('action', 'save');
                formData.append('name', personName);
                formData.append('data', JSON.stringify(availability));
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úì Datos guardados para ${personName}`);
                    } else {
                        alert('Error al guardar: ' + (result.message || 'Error desconocido'));
                    }
                } catch (error) {
                    console.error('Error guardando datos:', error);
                    alert('Error al guardar. Verifica tu conexi√≥n.');
                } finally {
                    setLoading(false);
                }
            };

            const loadPersonData = async (name) => {
                if (!name) return;

                setLoading(true);
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=get&name=${encodeURIComponent(name)}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        setAvailability(result.data);
                    } else {
                        setAvailability({});
                    }
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    alert('Error al cargar datos.');
                } finally {
                    setLoading(false);
                }
            };

            const deletePersonData = async () => {
                if (!personName) {
                    alert('Selecciona un nombre para eliminar');
                    return;
                }

                if (!confirm(`¬øSeguro que quieres eliminar TODOS los datos de ${personName}? Esta acci√≥n no se puede deshacer.`)) {
                    return;
                }

                setLoading(true);
                
                const formData = new FormData();
                formData.append('action', 'delete');
                formData.append('name', personName);
                
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úì Datos eliminados para ${personName}`);
                        setAvailability({});
                        setPersonName('');
                    } else {
                        alert('Error al eliminar: ' + (result.message || 'Error desconocido'));
                    }
                } catch (error) {
                    console.error('Error eliminando datos:', error);
                    alert('Error al eliminar.');
                } finally {
                    setLoading(false);
                }
            };

            const renderCalendar = () => {
                const daysInMonth = getDaysInMonth(currentMonth);
                const firstDay = getFirstDayOfMonth(currentMonth);
                const days = [];

                // D√≠as vac√≠os al inicio
                for (let i = 0; i < firstDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-12"></div>);
                }

                // D√≠as del mes
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = getDateString(currentMonth, day);
                    days.push(
                        <button
                            key={day}
                            onClick={() => handleDayClick(dateString)}
                            className={`h-12 rounded-lg flex items-center justify-center font-medium transition-colors ${getDayColor(dateString)}`}
                            disabled={loading}
                        >
                            {day}
                        </button>
                    );
                }

                return days;
            };

            // Mostrar pantalla de login si no est√° autenticado
            if (!isAuthenticated) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full">
                            <div className="text-center mb-8">
                                <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                    Calendario de Disponibilidad 2026
                                </h1>
                                <p className="text-gray-600">
                                    Introduce la contrase√±a para acceder
                                </p>
                            </div>

                            <form onSubmit={handleLogin} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">
                                        Contrase√±a
                                    </label>
                                    <input
                                        type="password"
                                        value={passwordInput}
                                        onChange={(e) => setPasswordInput(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        placeholder="Introduce la contrase√±a"
                                        autoFocus
                                    />
                                    {passwordError && (
                                        <p className="mt-2 text-sm text-red-600">
                                            {passwordError}
                                        </p>
                                    )}
                                </div>

                                <button
                                    type="submit"
                                    className="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
                                >
                                    Acceder
                                </button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex justify-between items-center mb-6">
                                <h1 className="text-3xl font-bold text-gray-800">
                                    Calendario de Disponibilidad 2026
                                </h1>
                                <button
                                    onClick={handleLogout}
                                    className="px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors"
                                >
                                    üö™ Cerrar sesi√≥n
                                </button>
                            </div>

                            {!sheetConfigured && (
                                <div className="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
                                    <div className="flex">
                                        <div className="flex-shrink-0">
                                            <svg className="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                                <path fillRule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
                                            </svg>
                                        </div>
                                        <div className="ml-3">
                                            <p className="text-sm text-yellow-700">
                                                <strong>Configuraci√≥n pendiente:</strong> Por favor, configura la URL del script de Google Apps en el archivo HTML.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Selecciona tu nombre
                                </label>
                                <select
                                    value={personName}
                                    onChange={handleNameChange}
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    disabled={loading || !sheetConfigured}
                                >
                                    <option value="">-- Selecciona tu nombre --</option>
                                    {personList.map(name => (
                                        <option key={name} value={name}>{name}</option>
                                    ))}
                                </select>
                                <p className="mt-2 text-sm text-gray-500">
                                    Si tu nombre no aparece, escr√≠belo en la hoja de Google Sheets
                                </p>
                            </div>

                            <div className="flex items-center justify-between mb-6">
                                <button
                                    onClick={() => setCurrentMonth(Math.max(0, currentMonth - 1))}
                                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    disabled={currentMonth === 0}
                                >
                                    ‚Üê Anterior
                                </button>
                                
                                <h2 className="text-2xl font-bold text-gray-800">
                                    {months[currentMonth]} 2026
                                </h2>
                                
                                <button
                                    onClick={() => setCurrentMonth(Math.min(11, currentMonth + 1))}
                                    className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                                    disabled={currentMonth === 11}
                                >
                                    Siguiente ‚Üí
                                </button>
                            </div>

                            <div className="grid grid-cols-7 gap-2 mb-4">
                                {['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'].map(day => (
                                    <div key={day} className="text-center font-semibold text-gray-600 text-sm">
                                        {day}
                                    </div>
                                ))}
                            </div>

                            <div className="grid grid-cols-7 gap-2 mb-6">
                                {renderCalendar()}
                            </div>

                            <div className="bg-gray-50 rounded-lg p-4 mb-6">
                                <h3 className="font-semibold text-gray-700 mb-2">Leyenda:</h3>
                                <div className="flex flex-wrap gap-4 text-sm">
                                    <div className="flex items-center">
                                        <div className="w-6 h-6 bg-red-500 rounded mr-2"></div>
                                        <span>No disponible (1 clic)</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-6 h-6 bg-green-500 rounded mr-2"></div>
                                        <span>Disponible / Preferente (2 clics)</span>
                                    </div>
                                    <div className="flex items-center">
                                        <div className="w-6 h-6 bg-gray-100 border border-gray-300 rounded mr-2"></div>
                                        <span>Sin marcar</span>
                                    </div>
                                </div>
                                <p className="mt-2 text-xs text-gray-600">
                                    Haz clic en un d√≠a para cambiar: Sin marcar ‚Üí Rojo (1 clic) ‚Üí Verde (2 clics) ‚Üí Sin marcar (3 clics)
                                </p>
                            </div>

                            <div className="flex gap-3">
                                <button
                                    onClick={savePersonData}
                                    disabled={loading || !personName || !sheetConfigured}
                                    className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium"
                                >
                                    {loading ? 'Guardando...' : 'üíæ Guardar Cambios'}
                                </button>
                                
                                <button
                                    onClick={deletePersonData}
                                    disabled={loading || !personName}
                                    className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors font-medium"
                                >
                                    üóëÔ∏è Eliminar
                                </button>
                            </div>
                        </div>

                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h3 className="text-lg font-bold text-gray-800 mb-3">Instrucciones:</h3>
                            <ol className="list-decimal list-inside space-y-2 text-gray-700">
                                <li>Selecciona tu nombre del desplegable</li>
                                <li>Marca en <span className="text-red-600 font-bold">rojo</span> los d√≠as que NO est√°s disponible (1 clic)</li>
                                <li>Marca en <span className="text-green-600 font-bold">verde</span> los d√≠as que prefieres trabajar (2 clics)</li>
                                <li>Haz clic en "Guardar Cambios" para actualizar tus preferencias</li>
                                <li>Los datos se guardar√°n autom√°ticamente en Google Sheets</li>
                            </ol>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CalendarioDisponibilidad />, document.getElementById('root'));
    </script>
</body>
</html>
