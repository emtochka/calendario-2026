<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario Disponibilidad 2026</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // REEMPLAZAR CON TU URL DE GOOGLE APPS SCRIPT
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby85kyeZxTOVcdges29i_NXBNNCgahRLwXBFWp-mohFxNPJx3ARLBHvbOWS_PEtd6a_WA/exec';

        const CalendarioDisponibilidad = () => {
            const [currentMonth, setCurrentMonth] = useState(0);
            const [personName, setPersonName] = useState('');
            const [availability, setAvailability] = useState({});
            const [allData, setAllData] = useState([]);
            const [viewMode, setViewMode] = useState('calendar');
            const [loading, setLoading] = useState(false);
            const [sheetConfigured, setSheetConfigured] = useState(false);

            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];

            // Verificar conexi√≥n con Google Sheets
            useEffect(() => {
                checkConnection();
            }, []);

            const checkConnection = async () => {
                if (SCRIPT_URL.includes('TU_SCRIPT_ID')) {
                    setSheetConfigured(false);
                    return;
                }

                try {
                    const response = await fetch(`${SCRIPT_URL}?action=test`);
                    if (response.ok) {
                        setSheetConfigured(true);
                        loadAllData();
                    }
                } catch (error) {
                    console.error('Error conectando con Google Sheets:', error);
                    setSheetConfigured(false);
                }
            };

            const loadAllData = async () => {
                setLoading(true);
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=getAll`);
                    const data = await response.json();
                    
                    if (data.success && data.data) {
                        setAllData(data.data);
                    }
                } catch (error) {
                    console.error('Error cargando datos:', error);
                } finally {
                    setLoading(false);
                }
            };

            const getDaysInMonth = (month) => {
                return new Date(2026, month + 1, 0).getDate();
            };

            const getFirstDayOfMonth = (month) => {
                const firstDay = new Date(2026, month, 1).getDay();
                // Ajustar para que lunes sea el primer d√≠a (0)
                // domingo pasa de 0 a 6, lunes de 1 a 0, etc.
                return firstDay === 0 ? 6 : firstDay - 1;
            };

            const getDateString = (month, day) => {
                return `2026-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            };

            const handleDayClick = (dateString) => {
                setAvailability(prev => {
                    const current = prev[dateString] || 'neutral';
                    const next = current === 'neutral' ? 'unavailable' : 
                                 current === 'unavailable' ? 'available' : 'neutral';
                    return { ...prev, [dateString]: next };
                });
            };

            const getDayColor = (dateString) => {
                const status = availability[dateString] || 'neutral';
                if (status === 'available') return 'bg-green-500 text-white';
                if (status === 'unavailable') return 'bg-red-500 text-white';
                return 'bg-gray-100 hover:bg-gray-200';
            };

            const savePersonData = async () => {
                if (!personName.trim()) {
                    alert('Por favor ingresa tu nombre');
                    return;
                }

                if (!sheetConfigured) {
                    alert('Por favor configura la URL de Google Sheets en el c√≥digo');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'save',
                            name: personName,
                            data: JSON.stringify(availability)
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úì Datos guardados para ${personName}`);
                        setPersonName('');
                        setAvailability({});
                        await loadAllData();
                    } else {
                        alert('Error al guardar: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error guardando datos:', error);
                    alert('Error al guardar. Verifica tu conexi√≥n.');
                } finally {
                    setLoading(false);
                }
            };

            const loadPersonData = async () => {
                if (!personName.trim()) {
                    alert('Ingresa tu nombre para cargar tus datos');
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=get&name=${encodeURIComponent(personName)}`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        setAvailability(result.data);
                        alert(`‚úì Datos cargados para ${personName}`);
                    } else {
                        alert('No se encontraron datos previos. Puedes empezar a marcar el calendario.');
                        setAvailability({});
                    }
                } catch (error) {
                    console.error('Error cargando datos:', error);
                    alert('Error al cargar datos.');
                } finally {
                    setLoading(false);
                }
            };

            const deletePersonData = async () => {
                if (!personName.trim()) {
                    alert('Ingresa el nombre a eliminar');
                    return;
                }

                if (!confirm(`¬øSeguro que quieres eliminar los datos de ${personName}?`)) {
                    return;
                }

                setLoading(true);
                try {
                    const response = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'delete',
                            name: personName
                        })
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        alert(`‚úì Datos eliminados para ${personName}`);
                        setPersonName('');
                        setAvailability({});
                        await loadAllData();
                    } else {
                        alert('Error al eliminar: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error eliminando datos:', error);
                    alert('Error al eliminar.');
                } finally {
                    setLoading(false);
                }
            };

            const openGoogleSheet = () => {
                if (sheetConfigured) {
                    window.open('https://docs.google.com/spreadsheets/d/1s_DrHZLfP5uW5GoDzMvLB7Jju3WJWX3PHTnS2ZMoh1s/edit', '_blank');
                } else {
                    alert('Configura primero tu Google Sheet');
                }
            };

            const renderCalendar = () => {
                const daysInMonth = getDaysInMonth(currentMonth);
                const firstDay = getFirstDayOfMonth(currentMonth);
                const days = [];

                for (let i = 0; i < firstDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-12"></div>);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const dateString = getDateString(currentMonth, day);
                    days.push(
                        <button
                            key={day}
                            onClick={() => handleDayClick(dateString)}
                            className={`h-12 rounded flex items-center justify-center font-medium transition-colors ${getDayColor(dateString)}`}
                        >
                            {day}
                        </button>
                    );
                }

                return days;
            };

            const renderSummary = () => {
                if (allData.length === 0) {
                    return <p className="text-gray-500">No hay datos guardados a√∫n</p>;
                }

                return (
                    <div className="space-y-4">
                        {allData.map((person, idx) => {
                            const available = Object.values(person.availability).filter(v => v === 'available').length;
                            const unavailable = Object.values(person.availability).filter(v => v === 'unavailable').length;
                            
                            return (
                                <div key={idx} className="bg-white p-4 rounded-lg shadow border border-gray-200">
                                    <h3 className="font-bold text-lg mb-2">{person.name}</h3>
                                    <div className="flex gap-4 text-sm">
                                        <span className="text-green-600">‚úì Preferente: {available} d√≠as</span>
                                        <span className="text-red-600">‚úó No disponible: {unavailable} d√≠as</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4">
                    <div className="max-w-6xl mx-auto">
                        <h1 className="text-3xl font-bold text-center mb-2 text-gray-800">
                            Calendario de Disponibilidad 2026
                        </h1>
                        
                        {/* Indicador de conexi√≥n */}
                        <div className="text-center mb-6">
                            {sheetConfigured ? (
                                <span className="text-green-600 text-sm">‚óè Conectado a Google Sheets</span>
                            ) : (
                                <div className="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-2 rounded max-w-2xl mx-auto">
                                    <p className="font-bold">‚ö†Ô∏è Configuraci√≥n pendiente</p>
                                    <p className="text-sm">Sigue las instrucciones para conectar con Google Sheets</p>
                                </div>
                            )}
                        </div>

                        {/* Selector de vista */}
                        <div className="flex gap-2 mb-4 justify-center flex-wrap">
                            <button
                                onClick={() => setViewMode('calendar')}
                                className={`px-4 py-2 rounded ${viewMode === 'calendar' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                            >
                                üìÖ Calendario
                            </button>
                            <button
                                onClick={() => setViewMode('summary')}
                                className={`px-4 py-2 rounded ${viewMode === 'summary' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}
                            >
                                üë• Resumen ({allData.length})
                            </button>
                            <button
                                onClick={openGoogleSheet}
                                className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                            >
                                üìä Ver Google Sheet
                            </button>
                        </div>

                        {loading && (
                            <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl">
                                <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                <p className="text-gray-600">Procesando...</p>
                            </div>
                        )}

                        {viewMode === 'calendar' ? (
                            <>
                                {/* Formulario */}
                                <div className="bg-white p-6 rounded-lg shadow-md mb-6">
                                    <div className="flex gap-4 items-center flex-wrap mb-4">
                                        <input
                                            type="text"
                                            value={personName}
                                            onChange={(e) => setPersonName(e.target.value)}
                                            placeholder="Tu nombre"
                                            className="flex-1 min-w-[200px] px-4 py-2 border rounded focus:ring-2 focus:ring-blue-500"
                                        />
                                        <button
                                            onClick={loadPersonData}
                                            disabled={loading}
                                            className="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700 disabled:opacity-50"
                                        >
                                            üìÇ Cargar
                                        </button>
                                        <button
                                            onClick={savePersonData}
                                            disabled={loading}
                                            className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 font-medium disabled:opacity-50"
                                        >
                                            üíæ Guardar
                                        </button>
                                        <button
                                            onClick={deletePersonData}
                                            disabled={loading}
                                            className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 disabled:opacity-50"
                                        >
                                            üóëÔ∏è Eliminar
                                        </button>
                                    </div>
                                    <div className="mt-4 text-sm text-gray-600 space-y-1">
                                        <p><span className="inline-block w-4 h-4 bg-red-500 rounded mr-2"></span>Clic 1: No disponible (rojo)</p>
                                        <p><span className="inline-block w-4 h-4 bg-green-500 rounded mr-2"></span>Clic 2: Preferente (verde)</p>
                                        <p><span className="inline-block w-4 h-4 bg-gray-100 rounded mr-2"></span>Clic 3: Neutral</p>
                                    </div>
                                </div>

                                {/* Calendario */}
                                <div className="bg-white p-6 rounded-lg shadow-md">
                                    <div className="flex items-center justify-between mb-4">
                                        <button
                                            onClick={() => setCurrentMonth(Math.max(0, currentMonth - 1))}
                                            disabled={currentMonth === 0}
                                            className="px-4 py-2 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
                                        >
                                            ‚Üê Anterior
                                        </button>
                                        <h2 className="text-2xl font-bold">{months[currentMonth]} 2026</h2>
                                        <button
                                            onClick={() => setCurrentMonth(Math.min(11, currentMonth + 1))}
                                            disabled={currentMonth === 11}
                                            className="px-4 py-2 bg-gray-200 rounded disabled:opacity-50 hover:bg-gray-300"
                                        >
                                            Siguiente ‚Üí
                                        </button>
                                    </div>

                                    <div className="grid grid-cols-7 gap-2 mb-2">
                                        {['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'].map(day => (
                                            <div key={day} className="text-center font-bold text-gray-600 text-sm">
                                                {day}
                                            </div>
                                        ))}
                                    </div>

                                    <div className="grid grid-cols-7 gap-2">
                                        {renderCalendar()}
                                    </div>
                                </div>
                            </>
                        ) : (
                            <div className="bg-white p-6 rounded-lg shadow-md">
                                <h2 className="text-2xl font-bold mb-4">Resumen de Participantes</h2>
                                {renderSummary()}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<CalendarioDisponibilidad />, document.getElementById('root'));
    </script>
</body>
</html>
